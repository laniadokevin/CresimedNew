
@using System.Security.Claims;
@using Cresimed.Core.Entities.ViewModel.Admin
@using System.Globalization
@model DashboardAdminViewModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var userId = User.FindFirst(ClaimTypes.Name).Value;
    var percMount = (int)(((double)(Model.MonthIncome - Model.LastMonthIncome) / (double)Model.MonthIncome) * 100);
    var percUsers = (int)(((double)(Model.MonthUsers - Model.LastMonthUsers) / (double)Model.MonthUsers) * 100);
    var percAnualMount = (int)(((double)(Model.YearIncome - Model.LastYearIncome) / (double)Model.YearIncome) * 100);
    var percAnualUsers = (int)(((double)(Model.YearUsers - Model.LastYearUsers) / (double)Model.YearUsers) * 100);
    var nfi = new NumberFormatInfo { NumberDecimalSeparator = ",", NumberGroupSeparator = "." };
   
   

}

        <!-- partial -->

        <div class="main-panel">
          <div class="content-wrapper">
            
            <div class="row">
                <!-- Monthly Income -->
              <div class="col-xl-3 col-sm-6 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <div class="row">
                            @if (percMount < 0)
                            {
                                <div class="col-9">

                                    <div class="d-flex align-items-center align-self-start">
                                        <h3 class="mb-0">$@Model.MonthIncome.ToString("#,##0", nfi)</h3>
                                        <p class="text-danger ms-2 mb-0 font-weight-medium">

                                            @percMount%
                                        </p>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="icon icon-box-danger">
                                        <span class="mdi mdi-arrow-bottom-left icon-item"></span>
                                    </div>
                                </div>
                            }else{

                                <div class="col-9">
                                    <div class="d-flex align-items-center align-self-start">
                                        <h3 class="mb-0">$@Model.MonthIncome.ToString("#,##0", nfi)</h3>
                                        <p class="text-success ms-2 mb-0 font-weight-medium">+@percMount%</p>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="icon icon-box-success ">
                                        <span class="mdi mdi-arrow-top-right icon-item"></span>
                                    </div>
                                </div>
                            }
                        </div>
                    <h6 class="text-muted font-weight-normal">Monthly Income</h6>
                  </div>
                </div>
              </div>

                <!-- Last Year Income -->
              <div class="col-xl-3 col-sm-6 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <div class="row">
                            @if (percAnualMount < 0)
                            {
                                <div class="col-9">

                                    <div class="d-flex align-items-center align-self-start">
                                        <h3 class="mb-0">$@Model.YearIncome.ToString("#,##0", nfi)</h3>
                                        <p class="text-danger ms-2 mb-0 font-weight-medium">

                                            @percAnualMount%
                                        </p>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="icon icon-box-danger">
                                        <span class="mdi mdi-arrow-bottom-left icon-item"></span>
                                    </div>
                                </div>
                            }
                            else
                            {

                                <div class="col-9">
                                    <div class="d-flex align-items-center align-self-start">
                                        <h3 class="mb-0">$@Model.YearIncome.ToString("#,##0", nfi)</h3>
                                        <p class="text-success ms-2 mb-0 font-weight-medium">+@percAnualMount%</p>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="icon icon-box-success ">
                                        <span class="mdi mdi-arrow-top-right icon-item"></span>
                                    </div>
                                </div>
                            }
                    </div>
                    <h6 class="text-muted font-weight-normal">Last Year Income</h6>
                  </div>
                </div>
              </div>
                <!-- Monthly Users -->
              <div class="col-xl-3 col-sm-6 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <div class="row">
                            @if (percUsers < 0)
                            {
                                <div class="col-9">

                                    <div class="d-flex align-items-center align-self-start">
                                        <h3 class="mb-0">@Model.MonthUsers.ToString()</h3>
                                        <p class="text-danger ms-2 mb-0 font-weight-medium">

                                            @percUsers%
                                        </p>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="icon icon-box-danger">
                                        <span class="mdi mdi-arrow-bottom-left icon-item"></span>
                                    </div>
                                </div>
                            }
                            else
                            {

                                <div class="col-9">
                                    <div class="d-flex align-items-center align-self-start">
                                        <h3 class="mb-0">@Model.MonthUsers.ToString()</h3>
                                        <p class="text-success ms-2 mb-0 font-weight-medium">+@percUsers%</p>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="icon icon-box-success ">
                                        <span class="mdi mdi-arrow-top-right icon-item"></span>
                                    </div>
                                </div>
                            }
                    </div>
                    <h6 class="text-muted font-weight-normal">Monthly Users</h6>
                  </div>
                </div>
              </div>
                <!-- Last Year Users -->
              <div class="col-xl-3 col-sm-6 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <div class="row">
                          @if (percAnualUsers< 0)
                            {
                                <div class="col-9">

                                    <div class="d-flex align-items-center align-self-start">
                                        <h3 class="mb-0">@Model.YearUsers.ToString()</h3>
                                        <p class="text-danger ms-2 mb-0 font-weight-medium">

                                            @percAnualUsers%
                                        </p>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="icon icon-box-danger">
                                        <span class="mdi mdi-arrow-bottom-left icon-item"></span>
                                    </div>
                                </div>
                            }
                            else
                            {

                                <div class="col-9">
                                    <div class="d-flex align-items-center align-self-start">
                                        <h3 class="mb-0">@Model.YearUsers.ToString()</h3>
                                        <p class="text-success ms-2 mb-0 font-weight-medium">+@percAnualUsers%</p>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="icon icon-box-success ">
                                        <span class="mdi mdi-arrow-top-right icon-item"></span>
                                    </div>
                                </div>
                            }
                    </div>
                        <h6 class="text-muted font-weight-normal"> Last Year Users</h6>
                  </div>
                </div>
              </div>
            </div>
        <div class="row">
            <div class="col-lg-6 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">New Users</h4>
                        <canvas id="lineChart" style="height:250px"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Subs Amount</h4>
                        <canvas id="barChart" style="height:230px"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- table -->
            <div class="row ">
              <div class="col-12 grid-margin">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">Last Subs</h4>
                    <div class="table-responsive">
                      <table class="table">
                        <thead>
                          <tr>
                                        <th> Client Name </th>
                                        <th> Amount </th>
                                        <th> Date Added </th>
                                        <th> Date Payed </th>
                          </tr>
                        </thead>
                        <tbody>
                            @foreach(var e in Model.UsersSubscribedTable){
                                
                            <tr>
                                <td>
                                  <span class="ps-2">@e.User.FullName</span>
                                </td>
                                <td> $@e.Value.ToString("#,##0.00", nfi)</td>
                                <td> @e.User.DateAdded.ToString("dd/MM/yyyy")</td>
                                <td> @(e.DatePayed.HasValue?e.DatePayed.Value.ToString("dd/MM/yyyy"):"")</td>
                            </tr>
                            }
                          
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        <!-- messages -->
            <div class="row">
              <div class="col-md-6 col-xl-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex flex-row justify-content-between">
                      <h4 class="card-title">Messages</h4>
                            <a href="@Url.Action("Contacts","Grids")" class="text-muted mb-1 small">View all</a>
                    </div>
                    <div class="preview-list">
                        @foreach(var e in Model.Contacts){

                            <div class="preview-item border-bottom">
                        <div class="preview-thumbnail">
                        </div>
                        <div class="preview-item-content d-flex flex-grow">
                          <div class="flex-grow">
                            <div class="d-flex d-md-block d-xl-flex justify-content-between">
                              <h6 class="preview-subject">@e.Name</h6>

                                                <a href="@Url.Action("ViewContact", "Views",new { id = e.ContactID })" class="btn btn-dark"> <i class='mdi mdi-eye'></i></a>

                            </div>
                            <p class="text-muted text-small">@e.Subject</p>
                            <p class="text-muted">@e.Message</p>
                          </div>
                        </div>
                      </div>
                        }
                    </div>
                  </div>
                </div>
              </div>
            </div>
    </div>
</div>
          <!-- content-wrapper ends -->

    @section Scripts {

    <!-- plugins:js -->
    <script src="~/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <script src="~/vendors/chart.js/Chart.min.js"></script>
    <script src="~/vendors/progressbar.js/progressbar.min.js"></script>
    <script src="~/vendors/jvectormap/jquery-jvectormap.min.js"></script>
    <script src="~/vendors/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
    <script src="~/vendors/owl-carousel-2/owl.carousel.min.js"></script>
    <script src="~/js/jquery.cookie.js" type="text/javascript"></script>
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="~/js/off-canvas.js"></script>
    <script src="~/js/hoverable-collapse.js"></script>
    <script src="~/js/misc.js"></script>
    <script src="~/js/settings.js"></script>
    <script src="~/js/todolist.js"></script>
    <!-- endinject -->
    <!-- Custom js for this page -->
    <script src="~/js/dashboard.js"></script>
    <script>

        $(function () {
            /* ChartJS
             * -------
             * Data and config for chartjs
             */
            'use strict';

            var nombresMesesUsers = [@foreach (var e in Model.LineBarUsers)
        {
            var last = Model.LineBarUsers.Last();
            if (last.MonthName == e.MonthName)
                @Html.Raw('"'+e.MonthName+'"')
            else
                @Html.Raw('"'+e.MonthName+'"'+ ",")
            ;
        }];
            var nombresMesesAmount= [@foreach (var e in Model.LineBarAmount)
        {
            var last = Model.LineBarAmount.Last();
            if (last.MonthName == e.MonthName)
                @Html.Raw('"'+e.MonthName+'"')
            else
                @Html.Raw('"'+e.MonthName+'"'+ ",")
            ;
        }];

        var amounts = [@foreach (var e in Model.LineBarAmount)
        {
            var last = Model.LineBarAmount.Last();
            if (last.MonthName == e.MonthName)
                @Html.Raw(e.Amount)
            else
                @Html.Raw(e.Amount + ",")
            ;
        }];
        var counts = [@foreach (var e in Model.LineBarUsers)
        {
            var last = Model.LineBarUsers.Last(); 
            if (last.MonthName == e.MonthName)

                @Html.Raw(e.Count)
            else
                @Html.Raw(e.Count + ",")
            ;
        }];
        
            var dataUsers = {
                labels: nombresMesesUsers,
                datasets: [{
                    label: '# of Users',
                    data: counts,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255,99,132,1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1,
                    fill: false
                }]
            };
            var dataAmount = {
                labels: nombresMesesAmount,
                datasets: [{
                    label: '$',
                    data: amounts,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255,99,132,1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1,
                    fill: false
                }]
            };
            var options = {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        },
                        gridLines: {
                            color: "rgba(204, 204, 204,0.1)"
                        }
                    }],
                    xAxes: [{
                        gridLines: {
                            color: "rgba(204, 204, 204,0.1)"
                        }
                    }]
                },
                legend: {
                    display: false
                },
                elements: {
                    point: {
                        radius: 0
                    }
                }
            };

            if ($("#barChart").length) {
                var barChartCanvas = $("#barChart").get(0).getContext("2d");
                // This will get the first returned node in the jQuery collection.
                var barChart = new Chart(barChartCanvas, {
                    type: 'line',
                    data: dataAmount,
                    options: options
                });

            }

            if ($("#lineChart").length) {
                var lineChartCanvas = $("#lineChart").get(0).getContext("2d");
                var lineChart = new Chart(lineChartCanvas, {
                    type: 'line',
                    data: dataUsers,
                    options: options
                });
            }

        });

    </script>
        <!-- End custom js for this page -->
    <!-- End custom js for this page -->
  
    }